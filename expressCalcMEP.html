<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Экспресс-расчет Нагрузок НИС</title>
    <style>
      :root {
        /* Светлая тема */
        --bg-primary: #f5f5f5;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f8f9fa;
        --text-primary: #333333;
        --text-secondary: #34495e;
        --text-muted: #7f8c8d;
        --border-color: #ddd;
        --shadow-light: rgba(0, 0, 0, 0.1);
        --shadow-medium: rgba(0, 0, 0, 0.15);
        --accent-primary: #3498db;
        --accent-secondary: #2980b9;
        --accent-success: #1f874a;
        --accent-success-hover: #219a52;
        --accent-warning: #f39c12;
        --accent-error: #e74c3c;
        --info-bg: #fff3cd;
        --info-border: #ffeaa7;
        --info-text: #856404;
        --info-separator: #f1c40f;
        --input-focus: #3498db;
        --input-error-bg: #fdf2f2;
        --input-warning-bg: #fef9e7;
        --validation-error-bg: #fdf2f2;
        --validation-error-border: #e74c3c;
        --validation-warning-bg: #fef9e7;
        --validation-warning-border: #f39c12;
        --disabled-bg: #bdc3c7;
        --hover-bg: #f8f9fa;
        --separator-color: #ecf0f1;
        --table-border: #f8f9fa;
      }

      /* Темная тема */
      @media (prefers-color-scheme: dark) {
        :root {
          --bg-primary: #1a1a1a;
          --bg-secondary: #2d2d2d;
          --bg-tertiary: #3a3a3a;
          --text-primary: #e0e0e0;
          --text-secondary: #b0b0b0;
          --text-muted: #888888;
          --border-color: #555555;
          --shadow-light: rgba(0, 0, 0, 0.3);
          --shadow-medium: rgba(0, 0, 0, 0.4);
          --accent-primary: #3776bd;
          --accent-secondary: #357abd;
          --accent-success: #186b3b;
          --accent-success-hover: #1f8b4c;
          --accent-warning: #f39c12;
          --accent-error: #e74c3c;
          --info-bg: #3a3a2a;
          --info-border: #4a4a3a;
          --info-text: #d4af37;
          --info-separator: #5a5a4a;
          --input-focus: #4a9eff;
          --input-error-bg: #4a2a2a;
          --input-warning-bg: #4a3a2a;
          --validation-error-bg: #4a2a2a;
          --validation-error-border: #e74c3c;
          --validation-warning-bg: #4a3a2a;
          --validation-warning-border: #f39c12;
          --disabled-bg: #555555;
          --hover-bg: #404040;
          --separator-color: #555555;
          --table-border: #404040;
        }
      }

      /* Кастомные темы через data-theme */
      [data-theme="light"] {
        --bg-primary: #f5f5f5;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f8f9fa;
        --text-primary: #333333;
        --text-secondary: #34495e;
        --text-muted: #7f8c8d;
        --border-color: #ddd;
        --shadow-light: rgba(0, 0, 0, 0.1);
        --shadow-medium: rgba(0, 0, 0, 0.15);
        --accent-primary: #3498db;
        --accent-secondary: #2980b9;
        --accent-success: #27ae60;
        --accent-success-hover: #219a52;
        --accent-warning: #f39c12;
        --accent-error: #e74c3c;
        --info-bg: #fff3cd;
        --info-border: #ffeaa7;
        --info-text: #856404;
        --info-separator: #f1c40f;
        --input-focus: #3498db;
        --input-error-bg: #fdf2f2;
        --input-warning-bg: #fef9e7;
        --validation-error-bg: #fdf2f2;
        --validation-error-border: #e74c3c;
        --validation-warning-bg: #fef9e7;
        --validation-warning-border: #f39c12;
        --disabled-bg: #bdc3c7;
        --hover-bg: #f8f9fa;
        --separator-color: #ecf0f1;
        --table-border: #f8f9fa;
      }

      [data-theme="dark"] {
        --bg-primary: #1a1a1a;
        --bg-secondary: #2d2d2d;
        --bg-tertiary: #3a3a3a;
        --text-primary: #e0e0e0;
        --text-secondary: #b0b0b0;
        --text-muted: #888888;
        --border-color: #555555;
        --shadow-light: rgba(0, 0, 0, 0.3);
        --shadow-medium: rgba(0, 0, 0, 0.4);
        --accent-primary: #3a7dca;
        --accent-secondary: #357abd;
        --accent-success: #259755;
        --accent-success-hover: #1d944f;
        --accent-warning: #f39c12;
        --accent-error: #e74c3c;
        --info-bg: #3a3a2a;
        --info-border: #4a4a3a;
        --info-text: #d4af37;
        --info-separator: #5a5a4a;
        --input-focus: #3d82d0;
        --input-error-bg: #4a2a2a;
        --input-warning-bg: #4a3a2a;
        --validation-error-bg: #4a2a2a;
        --validation-error-border: #e74c3c;
        --validation-warning-bg: #4a3a2a;
        --validation-warning-border: #f39c12;
        --disabled-bg: #555555;
        --hover-bg: #404040;
        --separator-color: #555555;
        --table-border: #404040;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: var(--text-primary);
        background-color: var(--bg-primary);
        padding: 20px;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: var(--bg-secondary);
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 6px var(--shadow-light);
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 20px;
      }

      h1 {
        color: var(--text-primary);
        font-size: 2.2em;
        flex: 1;
        text-align: center;
      }

      .theme-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        background: var(--bg-tertiary);
        padding: 8px 12px;
        border-radius: 25px;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
      }

      .theme-toggle:hover {
        background: var(--hover-bg);
      }

      .theme-toggle-switch {
        position: relative;
        width: 50px;
        height: 26px;
        background: var(--border-color);
        border-radius: 13px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .theme-toggle-switch::before {
        content: "";
        position: absolute;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: var(--bg-secondary);
        top: 2px;
        left: 2px;
        transition: transform 0.3s ease;
        box-shadow: 0 2px 4px var(--shadow-light);
      }

      .theme-toggle-switch.active {
        background: var(--accent-primary);
      }

      .theme-toggle-switch.active::before {
        transform: translateX(24px);
      }

      .theme-icon {
        font-size: 16px;
        color: var(--text-muted);
      }

      .form-section {
        margin-bottom: 25px;
        padding: 20px;
        background-color: var(--bg-tertiary);
        border-radius: 8px;
        border-left: 4px solid var(--accent-primary);
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }

      .form-section h2 {
        color: var(--text-primary);
        margin-bottom: 15px;
        font-size: 1.3em;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      label {
        font-weight: 600;
        margin-bottom: 5px;
        color: var(--text-secondary);
      }

      input,
      select {
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        font-size: 14px;
        transition: border-color 0.3s ease, background-color 0.3s ease,
          color 0.3s ease;
        background-color: var(--bg-secondary);
        color: var(--text-primary);
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: var(--input-focus);
      }

      .input-error {
        border-color: var(--accent-error) !important;
        background-color: var(--input-error-bg);
      }

      .input-warning {
        border-color: var(--accent-warning) !important;
        background-color: var(--input-warning-bg);
      }

      .validation-message {
        font-size: 12px;
        margin-top: 5px;
        padding: 5px;
        border-radius: 3px;
      }

      .validation-error {
        color: var(--accent-error);
        background-color: var(--validation-error-bg);
        border: 1px solid var(--validation-error-border);
      }

      .validation-warning {
        color: var(--accent-warning);
        background-color: var(--validation-warning-bg);
        border: 1px solid var(--validation-warning-border);
      }

      .calculate-btn {
        background-color: var(--accent-primary);
        color: white;
        padding: 15px 30px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        margin: 20px auto;
        display: block;
        transition: background-color 0.3s ease;
      }

      .calculate-btn:hover {
        background-color: var(--accent-secondary);
      }

      .calculate-btn:disabled {
        background-color: var(--disabled-bg);
        cursor: not-allowed;
      }

      .results {
        margin-top: 30px;
        display: none;
      }

      .info-messages {
        margin-top: 20px;
        padding: 15px;
        background-color: var(--info-bg);
        border: 1px solid var(--info-border);
        border-radius: 5px;
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }

      .info-messages h3 {
        color: var(--info-text);
        margin-bottom: 10px;
      }

      .info-messages ul {
        list-style-type: none;
        padding: 0;
      }

      .info-messages li {
        padding: 8px 0;
        border-bottom: 1px solid var(--info-separator);
        line-height: 1.4;
        color: var(--text-primary);
      }

      .info-messages li:last-child {
        border-bottom: none;
      }

      .insufficient-data {
        color: var(--accent-warning);
        font-style: italic;
      }

      .rso-section {
        margin-bottom: 30px;
        background: var(--bg-secondary);
        border-radius: 8px;
        box-shadow: 0 2px 4px var(--shadow-light);
        overflow: hidden;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
      }

      .rso-header {
        background-color: var(--accent-primary);
        color: white;
        padding: 15px 20px;
        font-size: 1.2em;
        font-weight: 600;
        margin: 0;
      }

      .rso-content {
        padding: 20px;
      }

      .system-group {
        margin-bottom: 20px;
      }

      .system-group:last-child {
        margin-bottom: 0;
      }

      .system-title {
        font-size: 1.1em;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 2px solid var(--separator-color);
      }

      .parameter-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--table-border);
      }

      .parameter-item:last-child {
        border-bottom: none;
      }

      .parameter-name {
        font-weight: 500;
        color: var(--text-secondary);
      }

      .parameter-value {
        font-weight: 600;
        color: var(--text-primary);
      }

      .parameter-unit {
        font-size: 0.9em;
        color: var(--text-muted);
        margin-left: 5px;
      }

      .auto-fill-btn {
        background-color: var(--accent-success);
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .auto-fill-btn:hover {
        background-color: var(--accent-success-hover);
      }

      .footer {
        margin-top: 40px;
        padding: 20px;
        background-color: var(--bg-tertiary);
        border-radius: 8px;
        border-top: 3px solid var(--accent-primary);
        text-align: center;
        color: var(--text-muted);
        font-size: 0.9em;
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }

      .footer-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
      }

      .author-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .author-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--accent-primary),
          var(--accent-secondary)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 14px;
      }

      .version-info {
        font-size: 0.8em;
        opacity: 0.8;
      }

      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          text-align: center;
        }

        h1 {
          font-size: 1.8em;
        }

        .parameter-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 5px;
        }

        .container {
          padding: 15px;
        }

        .form-grid {
          grid-template-columns: 1fr;
        }

        .footer-content {
          flex-direction: column;
          text-align: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Экспресс-расчет нагрузок НИС</h1>
        <div class="theme-toggle">
          <span class="theme-icon">☀️</span>
          <div class="theme-toggle-switch" id="themeToggle"></div>
          <span class="theme-icon">🌙</span>
        </div>
      </div>

      <form id="calculationForm">
        <div class="form-section">
          <h2>Основные данные</h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="totalArea">Общая площадь здания (м²):</label>
              <input type="number" id="totalArea" min="0" step="0.01" />
              <div
                id="totalArea-validation"
                class="validation-message"
                style="display: none"
              ></div>
            </div>
            <div class="form-group">
              <label for="residentialArea">Жилая площадь (м²):</label>
              <input type="number" id="residentialArea" min="0" step="0.01" />
              <div
                id="residentialArea-validation"
                class="validation-message"
                style="display: none"
              ></div>
            </div>
            <div class="form-group">
              <label for="landArea">Площадь земельного участка (м²):</label>
              <input type="number" id="landArea" min="0" step="0.01" />
              <div
                id="landArea-validation"
                class="validation-message"
                style="display: none"
              ></div>
            </div>
            <div class="form-group">
              <label for="objectClass">Класс объекта:</label>
              <select id="objectClass">
                <option value="Стандарт">Стандарт</option>
                <option value="Бизнес/Премиум">Бизнес/Премиум</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2>Дополнительные данные</h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="floorCount">Этажность здания:</label>
              <input type="number" id="floorCount" min="1" max="50" step="1" />
              <div
                id="floorCount-validation"
                class="validation-message"
                style="display: none"
              ></div>
            </div>
            <div class="form-group">
              <label for="unitCount">Количество квартир:</label>
              <input type="number" id="unitCount" min="0" step="1" />
              <div
                id="unitCount-validation"
                class="validation-message"
                style="display: none"
              ></div>
            </div>
            <div class="form-group">
              <label for="hasGas">Тип плит:</label>
              <select id="hasGas">
                <option value="">Не указано</option>
                <option value="true">Газовые</option>
                <option value="false">Электрические</option>
              </select>
            </div>
            <div class="form-group">
              <label for="hasParking">Наличие паркинга:</label>
              <select id="hasParking">
                <option value="false">Нет</option>
                <option value="true">Есть</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2>Благоустройство территории</h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="roofArea">Площадь кровли (м²):</label>
              <input type="number" id="roofArea" min="0" step="0.01" />
              <div
                id="roofArea-validation"
                class="validation-message"
                style="display: none"
              ></div>
            </div>
            <div class="form-group">
              <label for="lawnArea">Площадь газонов (м²):</label>
              <input type="number" id="lawnArea" min="0" step="0.01" />
              <div
                id="lawnArea-validation"
                class="validation-message"
                style="display: none"
              ></div>
            </div>
            <div class="form-group">
              <label for="hardscapeArea">Площадь твердых покрытий (м²):</label>
              <input type="number" id="hardscapeArea" min="0" step="0.01" />
              <div
                id="hardscapeArea-validation"
                class="validation-message"
                style="display: none"
              ></div>
            </div>
            <div class="form-group">
              <label for="autoFillTerrain">Автозаполнение:</label>
              <button type="button" id="autoFillTerrain" class="auto-fill-btn">
                Рассчитать по нормативам
              </button>
            </div>
          </div>
        </div>

        <button type="submit" class="calculate-btn" id="calculateBtn">
          Рассчитать
        </button>
      </form>

      <div id="results" class="results">
        <h2>Результаты расчета</h2>
        <div id="resultsContainer"></div>

        <div id="infoMessages" class="info-messages">
          <h3>Дополнительная информация и рекомендации</h3>
          <ul id="messagesList"></ul>
        </div>
      </div>

      <div class="footer">
        <div class="footer-content">
          <div class="author-info">
            <div class="author-avatar">РИ</div>
            <div>
              <strong>Автор:</strong> Ромашов И.С.<br />
              <span class="version-info">Главный инженер проекта</span>
            </div>
          </div>
          <div class="version-info">
            Версия alpha 0.1 • 2025<br />
            Экспресс-расчет нагрузок НИС
          </div>
        </div>
      </div>
    </div>

    <script>
      // Константы для расчета
      const CONSTANTS = {
        DEFAULT_RESIDENTIAL_RATIO: 0.75, // Коэфф. жилой площади от общей по умолчанию
        // Электроснабжение
        ELEC_LOAD_FACTOR_STD: 0.055,
        ELEC_LOAD_FACTOR_PREMIUM: 0.075,
        ELEC_LOAD_FACTOR_RESIDENTIAL_STD: 0.065,
        ELEC_LOAD_FACTOR_RESIDENTIAL_PREMIUM: 0.085,
        ELEC_LOAD_PARKING: 0.02,
        ELEC_THRESHOLD_10KV: 670,
        ELEC_COOKING_MULTIPLIER: 1.15,

        // Нормативы для квартир
        STANDARD_APARTMENT_AREA: 65, // Стандартная площадь квартиры для таблицы СП
        LARGE_APARTMENT_THRESHOLD: 80, // Порог для больших квартир

        // Нормативы для паркинга
        NORM_SPACES_PER_UNIT_STD: 1.2, // Норматив машиноместа на квартиру
        NORM_SPACES_PER_UNIT_PREMIUM: 2.2, // Норматив для премиум-класса
        NORM_AREA_PER_SPACE: 30, // Площадь на 1 м/м

        // Теплоснабжение
        HEAT_LOAD_FACTOR_STD: 110,
        HEAT_LOAD_FACTOR_PREMIUM: 120,
        KW_TO_GCAL_H_FACTOR: 0.00086,

        // Водоснабжение
        AREA_PER_PERSON_STD: 33,
        WATER_NORM_DAY: 180,
        WATER_NORM_HOUR: 10.5,
        WATER_NORM_SECOND_Q0: 0.2,
        WATER_ALPHA_COEFF: 1.2,

        // Дождевая канализация
        COEFF_ROOF: 0.95,
        COEFF_ASPHALT: 0.85,
        COEFF_LAWN: 0.35,
        Q20_MOSCOW: 80,
        STORM_PARAM_N_MOSCOW: 0.71,

        // Нормативы
        MAX_AREA_RATIO: 0.85,
        MIN_AREA_RATIO: 0.45,
        MAX_FLOOR_COUNT: 50,
        MIN_FLOOR_COUNT: 1,
        TYPICAL_APARTMENT_AREA: 65,

        // Нормативы благоустройства
        NORM_LAWN_RATIO: 0.25,
        NORM_HARDSCAPE_RATIO: 0.35,
        NORM_BUILDING_RATIO: 0.2,
      };

      // Lookup таблица для электронагрузок (СП 256.1325800.2016)
      const ELEC_LOAD_TABLE = {
        gas: {
          1: 5.0,
          2: 4.6,
          3: 4.3,
          4: 4.1,
          5: 3.9,
          6: 3.8,
          7: 3.7,
          8: 3.6,
          9: 3.5,
          10: 3.4,
          15: 3.2,
          20: 3.0,
          25: 2.9,
          30: 2.8,
          40: 2.7,
          50: 2.6,
          60: 2.5,
          70: 2.4,
          80: 2.3,
          90: 2.2,
          100: 2.1,
          120: 2.0,
          150: 1.9,
          200: 1.8,
          300: 1.7,
          400: 1.6,
          500: 1.5,
          600: 1.4,
          700: 1.3,
          800: 1.2,
          900: 1.1,
          1000: 1.0,
        },
        electric: {
          1: 8.5,
          2: 7.8,
          3: 7.3,
          4: 6.9,
          5: 6.6,
          6: 6.4,
          7: 6.2,
          8: 6.0,
          9: 5.8,
          10: 5.7,
          15: 5.3,
          20: 5.0,
          25: 4.8,
          30: 4.6,
          40: 4.4,
          50: 4.2,
          60: 4.1,
          70: 4.0,
          80: 3.9,
          90: 3.8,
          100: 3.7,
          120: 3.6,
          150: 3.5,
          200: 3.4,
          300: 3.3,
          400: 3.2,
          500: 3.1,
          600: 3.0,
          700: 2.9,
          800: 2.8,
          900: 2.7,
          1000: 2.6,
        },
      };

      // Управление темой
      class ThemeManager {
        constructor() {
          this.themeToggle = document.getElementById("themeToggle");
          this.currentTheme = this.getStoredTheme() || this.getSystemTheme();
          this.init();
        }

        init() {
          this.setTheme(this.currentTheme);
          this.themeToggle.addEventListener("click", () => this.toggleTheme());
        }

        getSystemTheme() {
          return window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light";
        }

        getStoredTheme() {
          return localStorage.getItem("theme");
        }

        setTheme(theme) {
          this.currentTheme = theme;
          document.documentElement.setAttribute("data-theme", theme);
          localStorage.setItem("theme", theme);
          this.updateToggleAppearance();
        }

        toggleTheme() {
          const newTheme = this.currentTheme === "light" ? "dark" : "light";
          this.setTheme(newTheme);
        }

        updateToggleAppearance() {
          if (this.currentTheme === "dark") {
            this.themeToggle.classList.add("active");
          } else {
            this.themeToggle.classList.remove("active");
          }
        }
      }

      // Класс для валидации данных
      class DataValidator {
        constructor() {
          this.validationRules = new Map();
          this.setupValidationRules();
        }

        setupValidationRules() {
          this.validationRules.set("totalArea", {
            min: 50,
            max: 100000,
            warningMax: 50000,
            required: false,
          });

          this.validationRules.set("residentialArea", {
            min: 30,
            max: 85000,
            warningMax: 40000,
            required: false,
          });

          this.validationRules.set("landArea", {
            min: 100,
            max: 500000,
            warningMax: 100000,
            required: false,
          });

          this.validationRules.set("floorCount", {
            min: 1,
            max: 50,
            warningMax: 25,
            required: false,
          });

          this.validationRules.set("unitCount", {
            min: 1,
            max: 1000,
            warningMax: 500,
            required: false,
          });
        }

        validateField(fieldId, value) {
          const rule = this.validationRules.get(fieldId);
          if (!rule) return { valid: true };

          const numValue = parseFloat(value);

          if (value === "" || value === null || value === undefined) {
            if (rule.required) {
              return {
                valid: false,
                type: "error",
                message: "Поле обязательно для заполнения",
              };
            }
            return { valid: true };
          }

          if (isNaN(numValue)) {
            return {
              valid: false,
              type: "error",
              message: "Введите корректное число",
            };
          }

          if (numValue < rule.min) {
            return {
              valid: false,
              type: "error",
              message: `Минимальное значение: ${rule.min}`,
            };
          }

          if (numValue > rule.max) {
            return {
              valid: false,
              type: "error",
              message: `Максимальное значение: ${rule.max}`,
            };
          }

          if (rule.warningMax && numValue > rule.warningMax) {
            return {
              valid: true,
              type: "warning",
              message: `Большое значение. Проверьте корректность.`,
            };
          }

          return { valid: true };
        }

        validateRelationships(data) {
          const errors = [];
          const warnings = [];

          // Проверка соотношения жилая/общая площадь
          if (data.totalArea > 0 && data.residentialArea > 0) {
            const ratio = data.residentialArea / data.totalArea;
            if (ratio > CONSTANTS.MAX_AREA_RATIO) {
              errors.push(
                "Жилая площадь не может превышать 85% от общей площади"
              );
            } else if (ratio < CONSTANTS.MIN_AREA_RATIO) {
              warnings.push(
                "Жилая площадь менее 45% от общей - проверьте корректность"
              );
            }
          }

          // Проверка этажности и площади
          if (data.floorCount > 0 && data.totalArea > 0) {
            const floorArea = data.totalArea / data.floorCount;
            if (floorArea < 100) {
              warnings.push(
                "Очень маленькая площадь этажа. Проверьте этажность."
              );
            } else if (floorArea > 3000) {
              warnings.push(
                "Очень большая площадь этажа. Проверьте этажность."
              );
            }
          }

          // Проверка количества квартир
          if (data.unitCount > 0 && data.residentialArea > 0) {
            const avgApartmentArea = data.residentialArea / data.unitCount;
            if (avgApartmentArea < 20) {
              errors.push(
                "Слишком маленькая средняя площадь квартиры (менее 20 м²)"
              );
            } else if (avgApartmentArea > 200) {
              warnings.push(
                "Очень большая средняя площадь квартиры (более 200 м²)"
              );
            }
          }

          // Проверка площадей участка
          if (data.landArea > 0) {
            const totalTerrainArea =
              data.roofArea + data.lawnArea + data.hardscapeArea;
            if (totalTerrainArea > data.landArea * 1.1) {
              errors.push("Сумма площадей покрытий превышает площадь участка");
            }
          }

          return { errors, warnings };
        }
      }

      // ИСПРАВЛЕННЫЙ модуль расчета электроснабжения с гибридным подходом
      function calculateElectricity(data) {
        const {
          totalArea,
          residentialArea,
          unitCount,
          hasGas,
          objectClass,
          hasParking,
        } = data;

        let totalLoad = 0;
        let baseArea = 0;
        let method = "";
        let useHybrid = false;

        try {
          // ГИБРИДНЫЙ РАСЧЕТ - если есть и количество квартир, и площадь
          if (
            unitCount > 0 &&
            hasGas !== "" &&
            (residentialArea > 0 || totalArea > 0)
          ) {
            useHybrid = true;

            // Расчет средней площади квартиры
            const workingResidentialArea =
              residentialArea ||
              totalArea * CONSTANTS.DEFAULT_RESIDENTIAL_RATIO;
            const avgApartmentArea = workingResidentialArea / unitCount;

            // Базовый расчет по таблице СП
            const hasGasBool = hasGas === "true";
            const specificLoadTable = getSpecificLoad(unitCount, hasGasBool);

            // Корректировка на площадь квартир
            let areaCorrection = 1.0;
            if (avgApartmentArea > CONSTANTS.LARGE_APARTMENT_THRESHOLD) {
              // Для больших квартир применяем коэффициент пропорционально превышению
              areaCorrection =
                avgApartmentArea / CONSTANTS.STANDARD_APARTMENT_AREA;
              // Ограничиваем максимальный коэффициент
              areaCorrection = Math.min(areaCorrection, 3.0);
            }

            // Расчет нагрузки
            const apartmentLoad =
              specificLoadTable * unitCount * areaCorrection;
            const mopLoad = apartmentLoad * 0.12;
            const detailedLoad = apartmentLoad + mopLoad;

            // Альтернативный укрупненный расчет
            const isPremium = objectClass === "Бизнес/Премиум";
            let alternativeLoad = 0;

            if (totalArea > 0) {
              let baseCoeff = isPremium
                ? CONSTANTS.ELEC_LOAD_FACTOR_PREMIUM
                : CONSTANTS.ELEC_LOAD_FACTOR_STD;
              alternativeLoad = totalArea * baseCoeff;
            } else {
              let baseCoeff = isPremium
                ? CONSTANTS.ELEC_LOAD_FACTOR_RESIDENTIAL_PREMIUM
                : CONSTANTS.ELEC_LOAD_FACTOR_RESIDENTIAL_STD;
              alternativeLoad = workingResidentialArea * baseCoeff;
            }

            // Корректировка на тип плит для альтернативного расчета
            if (hasGas === "false") {
              alternativeLoad *= CONSTANTS.ELEC_COOKING_MULTIPLIER;
            }

            // Выбираем больший результат
            totalLoad = Math.max(detailedLoad, alternativeLoad);
            baseArea = totalArea || workingResidentialArea;

            method = `Гибридный расчет: ${unitCount} кв. (ср. ${Math.round(
              avgApartmentArea
            )} м²/кв.), ${hasGasBool ? "газовые" : "электрические"} плиты`;
            if (areaCorrection > 1.1) {
              method += `, корректировка на площадь ×${areaCorrection.toFixed(
                2
              )}`;
            }
            if (totalLoad === alternativeLoad) {
              method += ` (выбран укрупненный метод)`;
            }
          } else if (unitCount > 0 && hasGas !== "") {
            // Стандартный детализированный расчет (без площади)
            const hasGasBool = hasGas === "true";
            const specificLoad = getSpecificLoad(unitCount, hasGasBool);

            const apartmentLoad = specificLoad * unitCount;
            const mopLoad = apartmentLoad * 0.12;
            totalLoad = apartmentLoad + mopLoad;

            baseArea =
              totalArea ||
              residentialArea ||
              unitCount * CONSTANTS.TYPICAL_APARTMENT_AREA;
            method = `Детализированный расчет: ${unitCount} кв., ${
              hasGasBool ? "газовые" : "электрические"
            } плиты`;
          } else {
            // Укрупненный расчет по площади
            const isPremium = objectClass === "Бизнес/Премиум";

            if (totalArea > 0) {
              const baseCoeff = isPremium
                ? CONSTANTS.ELEC_LOAD_FACTOR_PREMIUM
                : CONSTANTS.ELEC_LOAD_FACTOR_STD;
              totalLoad = totalArea * baseCoeff;
              baseArea = totalArea;
              method = `Укрупненный расчет по общей площади (${totalArea} м²)`;
            } else if (residentialArea > 0) {
              const baseCoeff = isPremium
                ? CONSTANTS.ELEC_LOAD_FACTOR_RESIDENTIAL_PREMIUM
                : CONSTANTS.ELEC_LOAD_FACTOR_RESIDENTIAL_STD;
              totalLoad = residentialArea * baseCoeff;
              baseArea = residentialArea;
              method = `Укрупненный расчет по жилой площади (${residentialArea} м²)`;
            } else {
              return null;
            }

            // Корректировка на тип плит
            if (hasGas === "false") {
              totalLoad *= CONSTANTS.ELEC_COOKING_MULTIPLIER;
              method += ", электроплиты (+15%)";
            }

            method += `, ${objectClass}`;
          }

          // Добавление нагрузки паркинга
          if (hasParking === "true") {
            let parkingLoad = 0;
            let parkingMethod = "";

            // ПРИОРИТЕТНЫЙ РАСЧЕТ: по количеству квартир
            if (unitCount > 0) {
              // Определяем, является ли объект премиальным
              const isPremium = objectClass === "Бизнес/Премиум";

              // Выбираем правильный норматив в зависимости от класса
              const spacesPerUnitNorm = isPremium
                ? CONSTANTS.NORM_SPACES_PER_UNIT_PREMIUM
                : CONSTANTS.NORM_SPACES_PER_UNIT_STD;

              const estimatedSpaces = unitCount * spacesPerUnitNorm;
              const estimatedParkingArea =
                estimatedSpaces * CONSTANTS.NORM_AREA_PER_SPACE;
              parkingLoad = estimatedParkingArea * CONSTANTS.ELEC_LOAD_PARKING;

              // В сообщение добавляем информацию о примененном нормативе
              parkingMethod = `, +паркинг (~${Math.round(
                estimatedSpaces
              )} м/м по нормативу для '${
                isPremium ? "Бизнес/Премиум" : "Стандарт"
              }', ${Math.round(parkingLoad)} кВт)`;
            }
            // АЛЬТЕРНАТИВНЫЙ РАСЧЕТ (остается без изменений)
            else if (residentialArea > 0) {
              const ELEC_LOAD_PARKING_FROM_RESIDENTIAL = 0.015;
              parkingLoad =
                residentialArea * ELEC_LOAD_PARKING_FROM_RESIDENTIAL;
              parkingMethod = `, +паркинг (~${Math.round(
                parkingLoad
              )} кВт, по нормативу от жилой площади)`;
            }

            if (parkingLoad > 0) {
              totalLoad += parkingLoad;
              method += parkingMethod;
            }
          }

          return {
            P_calc: Math.round(totalLoad),
            category: baseArea > 150 ? "II категория" : "III категория",
            voltage:
              totalLoad > CONSTANTS.ELEC_THRESHOLD_10KV ? "10 кВ" : "0.4 кВ",
            requiresTP:
              totalLoad > CONSTANTS.ELEC_THRESHOLD_10KV
                ? "Да, требуется строительство 2-трансформаторной КТП"
                : "Нет",
            method: method,
            hybrid: useHybrid,
          };
        } catch (error) {
          console.error("Ошибка расчета электроснабжения:", error);
          return null;
        }
      }

      // Модуль расчета теплоснабжения
      function calculateHeating(data) {
        const { totalArea, residentialArea, objectClass, floorCount } = data;

        try {
          const areaToUse = totalArea > 0 ? totalArea : residentialArea;

          if (areaToUse <= 0) return null;

          let specificLoad =
            objectClass === "Бизнес/Премиум"
              ? CONSTANTS.HEAT_LOAD_FACTOR_PREMIUM
              : CONSTANTS.HEAT_LOAD_FACTOR_STD;

          // Корректировка на этажность
          if (floorCount > 0) {
            if (floorCount > 16) {
              specificLoad *= 1.1;
            } else if (floorCount <= 3) {
              specificLoad *= 0.95;
            }
          }

          const loadKW = (areaToUse * specificLoad) / 1000;
          const loadGcal = loadKW * CONSTANTS.KW_TO_GCAL_H_FACTOR;

          return {
            Q_max: loadGcal.toFixed(4),
            Q_max_kW: Math.round(loadKW),
            method: `Расчет по площади ${areaToUse} м²${
              floorCount > 0 ? `, ${floorCount} эт.` : ""
            }`,
          };
        } catch (error) {
          console.error("Ошибка расчета теплоснабжения:", error);
          return null;
        }
      }

      // Модуль расчета водоснабжения
      function calculateWaterSupply(data) {
        const { residentialArea, unitCount } = data;

        try {
          if (residentialArea <= 0) return null;

          let residents;
          if (unitCount > 0 && residentialArea > 0) {
            const avgApartmentArea = residentialArea / unitCount;
            const personsPerApartment =
              avgApartmentArea < 40 ? 2 : avgApartmentArea < 80 ? 2.5 : 3;
            residents = Math.ceil(unitCount * personsPerApartment);
          } else {
            residents = Math.ceil(
              residentialArea / CONSTANTS.AREA_PER_PERSON_STD
            );
          }

          const dailyConsumption =
            (residents * CONSTANTS.WATER_NORM_DAY) / 1000;
          const hourlyConsumption =
            (residents * CONSTANTS.WATER_NORM_HOUR) / 1000;
          const secondConsumption =
            CONSTANTS.WATER_NORM_SECOND_Q0 *
            CONSTANTS.WATER_ALPHA_COEFF *
            Math.sqrt(residents);

          return {
            Q_day: dailyConsumption.toFixed(2),
            q_hour_max: hourlyConsumption.toFixed(3),
            q_sec_max: secondConsumption.toFixed(2),
            residents: residents,
            method: `Расчет на ${residents} жителей`,
          };
        } catch (error) {
          console.error("Ошибка расчета водоснабжения:", error);
          return null;
        }
      }

      // Модуль расчета дождевой канализации
      function calculateStormwater(data) {
        const { landArea, roofArea, lawnArea, hardscapeArea } = data;

        try {
          if (!landArea || landArea <= 0) return null;

          let actualRoofArea = roofArea || 0;
          let actualLawnArea = lawnArea || 0;
          let actualHardscapeArea = hardscapeArea || 0;

          // Автоматическое заполнение отсутствующих данных
          if (
            actualRoofArea === 0 &&
            actualLawnArea === 0 &&
            actualHardscapeArea === 0
          ) {
            actualRoofArea = landArea * CONSTANTS.NORM_BUILDING_RATIO;
            actualLawnArea = landArea * CONSTANTS.NORM_LAWN_RATIO;
            actualHardscapeArea = landArea * CONSTANTS.NORM_HARDSCAPE_RATIO;
          } else {
            const totalSpecified =
              actualRoofArea + actualLawnArea + actualHardscapeArea;
            const remaining = landArea - totalSpecified;

            if (remaining > 0) {
              if (actualLawnArea === 0) actualLawnArea = remaining * 0.6;
              if (actualHardscapeArea === 0)
                actualHardscapeArea = remaining * 0.4;
            }
          }

          const totalArea =
            actualRoofArea + actualLawnArea + actualHardscapeArea;
          if (totalArea > landArea * 1.1) {
            throw new Error(
              "Сумма площадей покрытий превышает площадь участка"
            );
          }

          const F = landArea / 10000;
          const z_mid =
            (actualRoofArea * CONSTANTS.COEFF_ROOF +
              actualHardscapeArea * CONSTANTS.COEFF_ASPHALT +
              actualLawnArea * CONSTANTS.COEFF_LAWN) /
            landArea;

          const A =
            CONSTANTS.Q20_MOSCOW * Math.pow(20, CONSTANTS.STORM_PARAM_N_MOSCOW);
          const t_r = 15;
          const Q_rain_max =
            (A * z_mid * F) / Math.pow(t_r, CONSTANTS.STORM_PARAM_N_MOSCOW);

          return {
            Q_rain_max: Q_rain_max.toFixed(2),
            z_mid: z_mid.toFixed(3),
            method: `Расчет: кровля ${actualRoofArea.toFixed(
              0
            )} м², газоны ${actualLawnArea.toFixed(
              0
            )} м², покрытия ${actualHardscapeArea.toFixed(0)} м²`,
          };
        } catch (error) {
          console.error("Ошибка расчета дождевой канализации:", error);
          return null;
        }
      }

      // Инициализация валидатора
      const validator = new DataValidator();

      // Функция валидации поля
      function validateField(fieldId) {
        const field = document.getElementById(fieldId);
        const validation = validator.validateField(fieldId, field.value);
        const messageDiv = document.getElementById(`${fieldId}-validation`);

        field.classList.remove("input-error", "input-warning");
        messageDiv.style.display = "none";
        messageDiv.className = "validation-message";

        if (!validation.valid) {
          field.classList.add("input-error");
          messageDiv.className = "validation-message validation-error";
          messageDiv.textContent = validation.message;
          messageDiv.style.display = "block";
        } else if (validation.type === "warning") {
          field.classList.add("input-warning");
          messageDiv.className = "validation-message validation-warning";
          messageDiv.textContent = validation.message;
          messageDiv.style.display = "block";
        }

        return validation.valid;
      }

      // Функция получения удельной нагрузки
      function getSpecificLoad(unitCount, hasGas) {
        const table = hasGas ? ELEC_LOAD_TABLE.gas : ELEC_LOAD_TABLE.electric;
        const keys = Object.keys(table)
          .map(Number)
          .sort((a, b) => a - b);

        for (let i = 0; i < keys.length; i++) {
          if (unitCount <= keys[i]) {
            return table[keys[i]];
          }
        }
        return table[keys[keys.length - 1]];
      }

      // Автозаполнение благоустройства
      function autoFillTerrain() {
        const landArea =
          parseFloat(document.getElementById("landArea").value) || 0;
        const totalArea =
          parseFloat(document.getElementById("totalArea").value) || 0;
        const floorCount =
          parseInt(document.getElementById("floorCount").value) || 0;

        if (landArea <= 0) {
          alert("Сначала укажите площадь земельного участка");
          return;
        }

        // Правильный расчет площади кровли
        // Новая, более надежная логика:
        let roofArea;
        // Приоритет №1: Расчет через площадь и этажность (самый точный)
        if (totalArea > 0 && floorCount > 0) {
          roofArea = totalArea / floorCount;
        }
        // Приоритет №2: Расчет от площади участка по нормативу (надежный)
        else {
          roofArea = landArea * CONSTANTS.NORM_BUILDING_RATIO;
        }

        // Проверка, чтобы площадь кровли не была больше площади участка
        if (roofArea > landArea) {
          roofArea = landArea * CONSTANTS.NORM_BUILDING_RATIO;
        }

        const lawnArea = landArea * CONSTANTS.NORM_LAWN_RATIO;
        const hardscapeArea = landArea * CONSTANTS.NORM_HARDSCAPE_RATIO;

        document.getElementById("roofArea").value = roofArea.toFixed(0);
        document.getElementById("lawnArea").value = lawnArea.toFixed(0);
        document.getElementById("hardscapeArea").value =
          hardscapeArea.toFixed(0);

        ["roofArea", "lawnArea", "hardscapeArea"].forEach(validateField);
      }

      // Функция генерации подробных сообщений
      function generateMessages(results, data) {
        const messages = [];

        if (
          results.electricity &&
          results.electricity.P_calc > CONSTANTS.ELEC_THRESHOLD_10KV
        ) {
          messages.push(
            `ВНИМАНИЕ: Расчетная мощность превышает ${CONSTANTS.ELEC_THRESHOLD_10KV} кВт. В соответствии с ПП РФ №861 и практикой ПАО «Россети», для подключения объекта требуется получение ТУ на напряжение 10 кВ и строительство собственной 2-трансформаторной подстанции (КТП) на земельном участке. Это существенно влияет на бюджет и сроки реализации проекта.`
          );
        }

        if (data.landArea > 5000) {
          messages.push(
            `РЕКОМЕНДАЦИЯ: Для территорий со значительной площадью водосбора современные экологические требования г. Москвы делают практически обязательной установку Локальных Очистных Сооружений (ЛОС) на выпуске дождевой канализации перед сбросом в городскую сеть ГУП «Мосводосток». Необходимо предусмотреть на генплане место для их размещения.`
          );
        }

        if (results.heating && results.heating.Q_max > 0.5) {
          messages.push(
            `ИНФОРМАЦИЯ: Тепловая нагрузка объекта составляет ${results.heating.Q_max} Гкал/ч. Для подключения к сетям ПАО «МОЭК» потребуется подготовка детального баланса тепловых нагрузок с указанием распределения по назначению (отопление, вентиляция, ГВС).`
          );
        }

        if (data.floorCount > 16) {
          messages.push(
            `ВЫСОТНОЕ СТРОИТЕЛЬСТВО: При этажности более 16 этажей требуются дополнительные согласования с МЧС России и повышенные нормативы инженерного обеспечения. Рекомендуется предусмотреть резерв мощностей на 15-20%.`
          );
        }

        if (results.water && results.water.residents > 1000) {
          messages.push(
            `КРУПНЫЙ ЖИЛОЙ КОМПЛЕКС: При расчетном количестве жителей более 1000 человек рекомендуется уточнить нормативы водопотребления с учетом современных сантехнических приборов и возможности установки водосберегающих технологий.`
          );
        }

        if (results.electricity) {
          messages.push(`МЕТОД РАСЧЕТА: ${results.electricity.method}`);

          if (results.electricity.hybrid) {
            messages.push(
              `ГИБРИДНЫЙ РАСЧЕТ: Применен усовершенствованный метод, учитывающий как количество квартир, так и их фактическую площадь. Для больших квартир применяется корректирующий коэффициент, учитывающий повышенное энергопотребление.`
            );
          }
        }

        return messages;
      }

      // Основная функция расчета
      function performCalculation() {
        const data = {
          totalArea:
            parseFloat(document.getElementById("totalArea").value) || 0,
          residentialArea:
            parseFloat(document.getElementById("residentialArea").value) || 0,
          landArea: parseFloat(document.getElementById("landArea").value) || 0,
          objectClass: document.getElementById("objectClass").value,
          floorCount:
            parseInt(document.getElementById("floorCount").value) || 0,
          unitCount: parseInt(document.getElementById("unitCount").value) || 0,
          hasGas: document.getElementById("hasGas").value,
          hasParking: document.getElementById("hasParking").value,
          roofArea: parseFloat(document.getElementById("roofArea").value) || 0,
          lawnArea: parseFloat(document.getElementById("lawnArea").value) || 0,
          hardscapeArea:
            parseFloat(document.getElementById("hardscapeArea").value) || 0,
        };

        const relationshipValidation = validator.validateRelationships(data);
        if (relationshipValidation.errors.length > 0) {
          alert(
            "Ошибки в данных:\n" + relationshipValidation.errors.join("\n")
          );
          return;
        }

        const results = {
          electricity: calculateElectricity(data),
          heating: calculateHeating(data),
          water: calculateWaterSupply(data),
          stormwater: calculateStormwater(data),
        };

        displayResults(results);

        const messages = generateMessages(results, data);
        const messagesList = document.getElementById("messagesList");
        messagesList.innerHTML = messages
          .map((msg) => `<li>${msg}</li>`)
          .join("");
      }

      // Функция отображения результатов
      function displayResults(results) {
        const resultsContainer = document.getElementById("resultsContainer");
        let html = "";

        // ПАО «Россети Московский регион»
        html += '<div class="rso-section">';
        html += '<h3 class="rso-header">ПАО «Россети Московский регион»</h3>';
        html += '<div class="rso-content">';
        html += '<div class="system-group">';
        html += '<div class="system-title">Электроснабжение (ЭС)</div>';

        if (results.electricity) {
          html += `<div class="parameter-item">
                    <span class="parameter-name">Расчетная мощность</span>
                    <span class="parameter-value">${results.electricity.P_calc}<span class="parameter-unit">кВт</span></span>
                </div>`;
          html += `<div class="parameter-item">
                    <span class="parameter-name">Категория надежности</span>
                    <span class="parameter-value">${results.electricity.category}</span>
                </div>`;
          html += `<div class="parameter-item">
                    <span class="parameter-name">Уровень напряжения</span>
                    <span class="parameter-value">${results.electricity.voltage}</span>
                </div>`;
          html += `<div class="parameter-item">
                    <span class="parameter-name">Требуется ТП</span>
                    <span class="parameter-value">${results.electricity.requiresTP}</span>
                </div>`;
        } else {
          html +=
            '<div class="parameter-item"><span class="insufficient-data">Недостаточно данных для расчета</span></div>';
        }

        html += "</div></div></div>";

        // ПАО «МОЭК»
        html += '<div class="rso-section">';
        html += '<h3 class="rso-header">ПАО «МОЭК»</h3>';
        html += '<div class="rso-content">';
        html += '<div class="system-group">';
        html += '<div class="system-title">Теплоснабжение (ТС)</div>';

        if (results.heating) {
          html += `<div class="parameter-item">
                    <span class="parameter-name">Максимальная тепловая нагрузка</span>
                    <span class="parameter-value">${results.heating.Q_max}<span class="parameter-unit">Гкал/ч</span></span>
                </div>`;
          html += `<div class="parameter-item">
                    <span class="parameter-name">Максимальная тепловая нагрузка</span>
                    <span class="parameter-value">${results.heating.Q_max_kW}<span class="parameter-unit">кВт</span></span>
                </div>`;
        } else {
          html +=
            '<div class="parameter-item"><span class="insufficient-data">Недостаточно данных для расчета</span></div>';
        }

        html += "</div></div></div>";

        // АО «Мосводоканал»
        html += '<div class="rso-section">';
        html += '<h3 class="rso-header">АО «Мосводоканал»</h3>';
        html += '<div class="rso-content">';

        // Водоснабжение
        html += '<div class="system-group">';
        html += '<div class="system-title">Водоснабжение (В1)</div>';

        if (results.water) {
          html += `<div class="parameter-item">
                    <span class="parameter-name">Среднесуточный расход</span>
                    <span class="parameter-value">${results.water.Q_day}<span class="parameter-unit">м³/сут</span></span>
                </div>`;
          html += `<div class="parameter-item">
                    <span class="parameter-name">Максимальный часовой расход</span>
                    <span class="parameter-value">${results.water.q_hour_max}<span class="parameter-unit">м³/ч</span></span>
                </div>`;
          html += `<div class="parameter-item">
                    <span class="parameter-name">Максимальный секундный расход</span>
                    <span class="parameter-value">${results.water.q_sec_max}<span class="parameter-unit">л/с</span></span>
                </div>`;
        } else {
          html +=
            '<div class="parameter-item"><span class="insufficient-data">Недостаточно данных для расчета</span></div>';
        }

        html += "</div>";

        // Бытовая канализация
        html += '<div class="system-group">';
        html += '<div class="system-title">Бытовая канализация (К1)</div>';

        if (results.water) {
          html += `<div class="parameter-item">
                    <span class="parameter-name">Среднесуточный расход</span>
                    <span class="parameter-value">${results.water.Q_day}<span class="parameter-unit">м³/сут</span></span>
                </div>`;
          html += `<div class="parameter-item">
                    <span class="parameter-name">Максимальный часовой расход</span>
                    <span class="parameter-value">${results.water.q_hour_max}<span class="parameter-unit">м³/ч</span></span>
                </div>`;
          html += `<div class="parameter-item">
                    <span class="parameter-name">Максимальный секундный расход</span>
                    <span class="parameter-value">${results.water.q_sec_max}<span class="parameter-unit">л/с</span></span>
                </div>`;
        } else {
          html +=
            '<div class="parameter-item"><span class="insufficient-data">Недостаточно данных для расчета</span></div>';
        }

        html += "</div></div></div>";

        // ГУП «Мосводосток»
        html += '<div class="rso-section">';
        html += '<h3 class="rso-header">ГУП «Мосводосток»</h3>';
        html += '<div class="rso-content">';
        html += '<div class="system-group">';
        html += '<div class="system-title">Дождевая канализация (К2)</div>';

        if (results.stormwater) {
          html += `<div class="parameter-item">
                    <span class="parameter-name">Максимальный расход дождевых вод</span>
                    <span class="parameter-value">${results.stormwater.Q_rain_max}<span class="parameter-unit">л/с</span></span>
                </div>`;
          html += `<div class="parameter-item">
                    <span class="parameter-name">Коэффициент стока</span>
                    <span class="parameter-value">${results.stormwater.z_mid}</span>
                </div>`;
        } else {
          html +=
            '<div class="parameter-item"><span class="insufficient-data">Недостаточно данных для расчета</span></div>';
        }

        html += "</div></div></div>";

        resultsContainer.innerHTML = html;
        document.getElementById("results").style.display = "block";
      }

      // Функция полной валидации формы
      function validateForm() {
        const fieldIds = [
          "totalArea",
          "residentialArea",
          "landArea",
          "floorCount",
          "unitCount",
          "roofArea",
          "lawnArea",
          "hardscapeArea",
        ];
        let isValid = true;

        fieldIds.forEach((fieldId) => {
          if (!validateField(fieldId)) {
            isValid = false;
          }
        });

        const calculateBtn = document.getElementById("calculateBtn");
        calculateBtn.disabled = !isValid;

        return isValid;
      }

      // Инициализация приложения
      document.addEventListener("DOMContentLoaded", function () {
        // Инициализация менеджера тем
        const themeManager = new ThemeManager();

        // Инициализация формы
        validateForm();

        // Обработчики событий
        document
          .getElementById("calculationForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            if (validateForm()) {
              performCalculation();
            }
          });

        document
          .getElementById("autoFillTerrain")
          .addEventListener("click", autoFillTerrain);

        // Валидация в реальном времени
        const fieldIds = [
          "totalArea",
          "residentialArea",
          "landArea",
          "floorCount",
          "unitCount",
          "roofArea",
          "lawnArea",
          "hardscapeArea",
        ];

        fieldIds.forEach((fieldId) => {
          const field = document.getElementById(fieldId);
          field.addEventListener("input", function () {
            validateField(fieldId);
            setTimeout(validateForm, 100);
          });
        });
      });
    </script>
  </body>
</html>
